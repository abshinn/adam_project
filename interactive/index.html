<!DOCTYPE html>
<meta charset="utf-8">
<style>

.background {
  fill: none;
  pointer-events: all;
}

#states {
  fill: #aaa;
}

#states .active {
  fill: orange;
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}
/*
#districts {
  stroke-width: 1;
}
.district {
  stroke: #fff;
}
body {
  font: normal medium/1.4 sans-serif;
}
*/
#table {
  font: normal medium/1.4 sans-serif;
  border-collapse: collapse;
  width: 100%;
}
#table th, td {
  padding: 0.25rem;
  text-align: left;
  border: 1px solid #ccc;
}
#tbody tr:nth-child(odd) {
  background: #eee;
}
</style>
<body>
<div id="title" style="background-color:#FFA500;height:80px;width:1000px;float:left;"></div>
<div id="map" style="background-color:#F8F8F8;height:500px;width:550px;float:left;"></div>
<div id="table" style="background-color:#EEEEEE;height:500px;width:450px;float:left;"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 550,
    height = 500,
    centered;

var projection = d3.geo.albersUsa()
    .scale(750)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

var g = svg.append("g");

d3.json("json/states_usa.topo.json", function(error, us) {
  g.append("g")
   .attr("id", "states")
   .selectAll("path")
   .data(topojson.feature(us, us.objects.states).features)
   .enter().append("path")
   .attr("d", path)
   .on("click", clicked);

  g.append("path")
   .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
   .attr("id", "state-borders")
   .attr("d", path);
});

g.append("g").attr("class", "stable").attr("transform","translate(850,0)");


function draw_districts(state) {
    state_name = state.properties.name;

    var distarr = new Array();

    console.log(state_name)
    d3.json("json/districts.topo.json", function(error, us) {
      g.append("g")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.districts).features.filter(function(d) { 
                return state_name == d.properties.state; }))
        .enter()
        .append("path")
        .attr("id", "district")
        .attr("class", function(d) { distarr.push(d.properties); return d.properties.name.replace(/\s/g, "") })
        .attr("d", path.pointRadius(2))
        .on("mouseover", function(d){ 
                d3.select(this)
                  .transition()
                  .duration(200)
                  .ease("back-in")
                  .attr("d", path.pointRadius(3.5));
                   console.log(d.properties.name.replace(/\s/g, ""));
                d3.selectAll("."+d.properties.name.replace(/\s/g, ""))
                  .style("background-color", "lightblue"); })  
        .on("mouseout", function(d) { 
                d3.select(this)
                  .transition()
                  .ease("back-out")
                  .duration(400)
                  .attr("d", path.pointRadius(2));
                d3.selectAll("."+d.properties.name.replace(/\s/g, ""))
                  .style("background-color", "white"); });

      draw_table(distarr, state);
    });
}

function draw_table(distarr, state) {

    // header
    d3.select("#table").selectAll("th")
    .data(d3.keys(distarr[0]))
    .enter().append("th").text(function(d){return d});

    // rows
    var tr = d3.select("#table").selectAll("tr")
      .data(distarr).enter().append("tr").attr("class", function(d){ return d.name.replace(/\s/g, ""); })
      .on("mouseover", function(d){
              d3.select(this).style("background-color", "lightblue");
              d3.selectAll("."+d.name.replace(/\s/g, ""))
                  .transition()
                  .duration(400)
                  .attr("d", path.pointRadius(3.5))})
      .on("mouseout", function(d){
              console.log(d.name.replace(/\s/g, ""));
              d3.select(this).style("background-color", "white");
              d3.selectAll("."+d.name.replace(/\s/g, ""))
                  .transition()
                  .duration(400)
                  .attr("d", path.pointRadius(2))});
//       .transition()//.style("fill", "#345")});
//       .duration(200);

    // create cells
    var td = tr.selectAll("td")
      .data(function(d){return d3.values(d)})
      .enter().append("td")
      .text(function(d) {return d})
}

function clicked(d) {
  var x, y, k;

  // event handler
  if (d && centered !== d) {
console.log("state clicked");
    d3.selectAll("#district").remove();
    d3.select("#table").selectAll("tr").remove();
    d3.select("#table").selectAll("th").remove();
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 2.3;
    centered = d;
    draw_districts(d);
  } else {
      console.log("none clicked");
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
    d3.selectAll("#district").remove();
    d3.select("#table").selectAll("tr").remove();
    d3.select("#table").selectAll("th").remove();
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

//   if (state && centered !== d)
//         .attr("d", path.pointRadius(1./xyz[2]))
//             .on("mouseover", function(d){ 
//               d3.select(this).style("fill", "orange");
//               console.log(d3.selectAll("d.properties.leaid"));
//               d3.selectAll("."+d.properties.name.replace(/\s/g, "")).style("background-color", "lightblue")})  
//             .on("mouseout", function(d) { 
//               d3.select(this).style("fill", "#345");
//               d3.selectAll("."+d.properties.name.replace(/\s/g, "")).style("background-color", "white");
//       });
}

</script>
