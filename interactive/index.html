<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
     <script src="jquery-2.0.0.js"></script>
    <style>
    #map {
      background-color: #fff;
      border: 1px solid #ccc;
    }
    .background {
      fill: none;
      pointer-events: all;
    }
    #states {
      fill: #cde;
      stroke: #fff;
      stroke-linejoin: round;
      stroke-linecap: round;
    }
    #states .active {
      fill: #89a;
    }
    #districts {
      stroke-width: 0;
    }
    .district {
      fill: #345;
  /*    stroke: #fff;*/
    }
    pre.prettyprint {
      border: 1px solid #ccc;
      margin-bottom: 0;
      padding: 9.5px;
    }
#table {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    width: 100%;
    border-collapse: collapse;
}

#table td, #table th {
    font-size: 1em;
    border: 1px solid #98bf21;
    padding: 3px 7px 2px 7px;
}

#table th {
    font-size: 1.1em;
    text-align: left;
    padding-top: 5px;
    padding-bottom: 4px;
    background-color: #89a;
/*    background-color: #A7C942; */
    color: #ffffff;
}

#table tr.alt td {
    color: #000000;
    background-color: #EAF2D3;
}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="table"></div>
    <script src="d3.v3.min.js"></script>
    <script src="topojson.v1.min.js"></script>
    <script>

    var m_width = $("#map").width(),
//         width = 938,
//         height = 500,
        width = 340,
        height = 140,
        state;

    var projection = d3.geo.albersUsa()
        .scale(300)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("#map").append("svg")
        .attr("preserveAspectRatio", "xMidYMid")
        .attr("viewBox", "0 0 " + width + " " + height)
        .attr("width", m_width)
        .attr("height", m_width * height / width);

    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", state_clicked);

    var g = svg.append("g");
    
    d3.json("json/states_usa.topo.json", function(error, us) {
    g.append("g")
      .attr("id", "states")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
      .enter()
      .append("path")
      .attr("id", function(d) { return d.id; })
      .attr("class", "active")
      .attr("d", path)
      .on("click", state_clicked);
    });

    
    function zoom(xyz) {
      g.transition()
        .duration(750)
        .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
        .selectAll(["#states", "#districts"])
        .style("stroke-width", 0.5 / xyz[2] + "px")
        .selectAll(".district")
        .attr("d", path.pointRadius(1./xyz[2]));
    }

    function get_xyz(d) {
      var bounds = path.bounds(d);
      var w_scale = (bounds[1][0] - bounds[0][0]) / width;
      var h_scale = (bounds[1][1] - bounds[0][1]) / height;
      var z = .96 / Math.max(w_scale, h_scale);
      var x = (bounds[1][0] + bounds[0][0]) / 2;
      var y = (bounds[1][1] + bounds[0][1]) / 2;
      return [x, y, z];
    }

    function state_clicked(d) {
      d3.selectAll("#district").remove();
      d3.select("#table").selectAll("tr").remove();
      d3.select("#table").selectAll("th").remove();
//       g.selectAll("paths").classed("active");

      if (d && state !== d) {
        var xyz = get_xyz(d);
        state = d;

        state_name = state.properties.name;

        var distarr = new Array();

        console.log(state_name)
        d3.json("json/districts.topo.json", function(error, us) {
          g.append("g")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.districts).features.filter(function(d) { return state_name == d.properties.state; }))
            .enter()
            .append("path")
            .attr("id", "district")
            .attr("class", function(d) {  distarr.push(d.properties); return d.properties.state})
            .attr("d", path.pointRadius(1./xyz[2]))
            .on("mouseover", function(d){ 
                console.log(d.properties.name);
                d3.select(this).style("fill", "orange").classed("selected", true);
                d3.selectAll("." + d.properties.state).style("background-color", "aliceblue").classed("selected", true)})  
            .on("mouseout", function(d) { 
              d3.select(this).style("fill", "#345").classed("selected", false);
              d3.selectAll("." + d.properties.state).style("background-color", "white").classed("selected", false);
          });

      console.log(distarr);

      // create table header
      d3.select("#table").selectAll("th")
        .data(d3.keys(distarr[0]))
        .enter().append("th").text(function(d){return d});
        // create rows
       var tr = d3.select("#table").selectAll("tr")
        .data(distarr).enter().append("tr").attr("class", function(d){ return d.state; })
        .on("mouseover", function(d){
                d3.select(this).style("background-color", "aliceblue").classed("selected", true);
                d3.selectAll("."+d.state).style("fill", "orange").classed("selected", true) ;
                
                }) 
        .on("mouseout", function(d){
          d3.select(this).style("background-color", "white").classed("selected", false) 
          d3.selectAll("."+d.state).style("fill", "#345").classed("selected", false) });
        // create cells
        var td = tr.selectAll("td")
          .data(function(d){return d3.values(d)})
          .enter().append("td")
          .text(function(d) {return d})

          zoom(xyz);
        });      
      } else {
        var xyz = [width / 2, height / 2, 1];
        state = null;
        zoom(xyz);
      }
    }

    $(window).resize(function() {
      var w = $("#map").width();
      svg.attr("width", w);
      svg.attr("height", w * height / width);
    });

    // template table
//     var dataset = [],
//     tmpDataset = [],
//     i, j;
// 
//     for (i = 0; i < 5; i++) {
//         for (j = 0, tmpDataset = []; j < 3; j++) {
//             tmpDataset.push("Row:"+i+",Col:"+j);
//         }
//         dataset.push(tmpDataset);
//     }
//         
//     d3.select("#table")
//         .append("table")
//         .style("border-collapse", "collapse")
//         .style("border", "2px black solid")
//         
//         .selectAll("tr")
//         .data(dataset)
//         .enter().append("tr")
//         .on("mouseover", function(){d3.select(this).style("background-color", "aliceblue")}) 
//         .on("mouseout", function(){d3.select(this).style("background-color", "white")}) 
//         
//         .selectAll("td")
//         .data(function(d){return d;})
//         .enter().append("td")
//         .style("border", "1px black solid")
//         .style("padding", "10px")
//         .text(function(d){return d;})
//         .style("font-size", "12px");
    </script>
  </body>
</html>
